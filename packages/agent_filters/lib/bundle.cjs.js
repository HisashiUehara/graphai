"use strict";var e=require("ajv"),t=require("graphai");const r=(t,r)=>{if(!(new e).compile(t)(r))throw new Error("schema not matched");return!0};const a=async(e,t,r,a)=>{const n=async function*(e,t){const{params:r,inputs:a,namedInputs:n,debugInfo:s,filterParams:o}=t,i={params:r,inputs:a,debugInfo:s,filterParams:o,namedInputs:n},c=await fetch(e,{headers:{"Content-Type":"text/event-stream"},method:"POST",body:JSON.stringify(i)}),u=c.body?.getReader();if(200!==c.status||!u)throw new Error("Request failed");const p=new TextDecoder("utf-8");let l=!1;for(;!l;){const{done:e,value:t}=await u.read();if(e)l=e,u.releaseLock();else{const e=p.decode(t,{stream:!0});yield e}}}(t,r),s=[];for await(const t of n)a&&console.log(t),t&&(s.push(t),-1===s.join("").indexOf("___END___")&&e.filterParams.streamTokenCallback&&e.filterParams.streamTokenCallback(t));const o=s.join("").split("___END___")[1];return JSON.parse(o)},n=e=>Array.isArray(e)?e.map((e=>n(e))):t.isObject(e)?Object.keys(e).sort().reduce(((t,r)=>(t[r]=e[r],t)),{}):e;exports.agentFilterRunnerBuilder=e=>{const t=e;return(e,r)=>{let a=0;const n=e=>{const s=t[a++];return s?s.agent(e,n):r(e)};return n(e)}},exports.agentInputValidator=r,exports.cacheAgentFilterGenerator=e=>{const{getCache:t,setCache:r}=e;return async(e,a)=>{const{namedInputs:s,params:o,debugInfo:i}=e;if("pureAgent"===e.cacheType){const{agentId:c}=i,u=JSON.stringify(n({namedInputs:s,params:o,agentId:c})),p=await t(u);if(p)return p;const l=await a(e);return await r(u,JSON.stringify(l)),l}return"impureAgent"===e.cacheType&&(e.filterParams.cache={getCache:t,setCache:r}),a(e)}},exports.httpAgentFilter=async(e,t)=>{const{params:r,inputs:n,debugInfo:s,filterParams:o,namedInputs:i}=e;if(o?.server){const{baseUrl:t,isDebug:c,serverAgentUrlDictionary:u}=o.server,p=s.agentId,l=void 0!==o.streamTokenCallback,d=u&&p&&u[p]?u[p]:[t,p].join("/");void 0===d&&console.log("httpAgentFilter: Url is not defined");const m={params:r,inputs:n,debugInfo:s,filterParams:o,namedInputs:i};return l?await a(e,d,m,c):await(async(e,t)=>{const r=await fetch(e,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await r.json()})(d,m)}return t(e)},exports.namedInputValidatorFilter=async(e,t)=>{const{inputSchema:a,namedInputs:n}=e;return a&&"array"!==a.type&&r(a,n||{}),t(e)},exports.sortObjectKeys=n,exports.streamAgentFilterGenerator=e=>async(t,r)=>(t.debugInfo.isResult&&(t.filterParams.streamTokenCallback=r=>{e(t,r)}),r(t));
//# sourceMappingURL=bundle.cjs.js.map
